<!DOCTYPE html>
<html>
<head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpg" href="../static/fhirLogo.jpg">
    <title id="pageTitle">{% block pageTitle %}FHIR Visualiation: Dashboard {% endblock %}</title>

    <style>
      .w3-teal {
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      .username {
          margin-right: 20px; /* Adjust the margin as needed */
      }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>

</head>

<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<body>
<div class="w3-sidebar w3-bar-block w3-card w3-animate-left" style="display:none" id="mySidebar">
  <button class="w3-bar-item w3-button w3-large"
  onclick="w3_close()">Close &times;</button>
  <button class="w3-button w3-block w3-left-align" id = "clinicalBtn" onclick="myAccFunc(0)">
  Clinical <i class="fa fa-caret-down"></i>
  </button>
  <div id="clinicalAcc" class="w3-hide w3-white w3-card">
    <a href="/patient" class="w3-bar-item w3-button">&#8226;Patient</a>
    <a href="/practitioner" class="w3-bar-item w3-button">&#8226;Practitioner</a> 		
    <a href="/procedure" class="w3-bar-item w3-button">&#8226;Procedure</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;CarePlan-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Goal-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Family History-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;RiskAssessment-NotImplemented</a>
  </div>
  
  <button class="w3-button w3-block w3-left-align" id="diagnosticBtn" onclick="myAccFunc(1)">
  Diagnostics-Not Implemented<i class="fa fa-caret-down"></i>
  </button>
   <div id="diagnosticAcc" class="w3-hide w3-white w3-card">
    <a href="#" class="w3-bar-item w3-button">&#8226;Observation-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Report-NotImplemented</a> 		
    <a href="#" class="w3-bar-item w3-button">&#8226;Specimen-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;ImagingStudy-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Genomics-NotImplemented</a>
    
  </div>
  
  <button class="w3-button w3-block w3-left-align" id="medicationBtn" onclick="myAccFunc(2)">
  Medications<i class="fa fa-caret-down"></i>
  </button>
   <div id="medicationAcc" class="w3-hide w3-white w3-card">
    <a href="/medRequest" class="w3-bar-item w3-button">&#8226;Medication Requests</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Dispense-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Administration-NotImplemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Statement-Not Implemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Immunization-Not Implemented</a>
  </div>
  
  <button class="w3-button w3-block w3-left-align" id="workflowBtn" onclick="myAccFunc(3)">
  Work Flow-Not Implemented<i class="fa fa-caret-down"></i>
  </button>
   <div id="workflowAcc" class="w3-hide w3-white w3-card">
    <a href="#" class="w3-bar-item w3-button">&#8226;Introduction + Task-Not Implemented</a>	
    <a href="#" class="w3-bar-item w3-button">&#8226;Appointment-Not Implemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Schedule-Not Implemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;Referral-Not Implemented</a>
    <a href="#" class="w3-bar-item w3-button">&#8226;PlanDefinition-Not Implemented</a>
  </div>
  
  {% if role == 'admin' %}
    <button class="w3-button w3-block w3-left-align" id="financialBtn" onclick="myAccFunc(4)">
    Financial<i class="fa fa-caret-down"></i>
    </button>
    <div id="financialAcc" class="w3-hide w3-white w3-card">
      <a href="claim" class="w3-bar-item w3-button">&#8226;Claim</a>	
      <a href="#" class="w3-bar-item w3-button">&#8226;Account-Not Implemented</a>
      <a href="#" class="w3-bar-item w3-button">&#8226;Invoice-Not Implemented</a>
      <a href="#" class="w3-bar-item w3-button">&#8226;ChargeItem-Not Implemented</a>
      <a href="#" class="w3-bar-item w3-button">&#8226;Coverage + Eligibility-Not Implemented</a>
      <a href="#" class="w3-bar-item w3-button">&#8226;Request & Response-Not Implemented</a>
      <a href="#" class="w3-bar-item w3-button">&#8226;ExplanationOfBenefit-Not Implemented</a>
    </div>
  {% endif %}
  
</div>

<div id="main">

<div class="w3-teal">
  <button id="openNav" class="w3-button w3-teal w3-xlarge" onclick="w3_open()">&#9776;</button>
  <div class="w3-container">
    <h1>{% block pageHeadline %}FHIR Visualization {% endblock %}</h1>
  </div>
  <div class="username">
    <h1>{{ username }}</h1><p><a href="/logout">Logout</a></p>
  </div>
</div>

<div class="w3-container">

{% block content %}
<p>Welcome, {{ username }}!</p>
<p>The Idea is for this to be a dashboard page with some general charts, and then the other pages can grab sepcifics</p>
    
</div>


<div class="result-container" style = "width: calc(67% - 20px); padding: 20px; overflow: auto;">

</div>


{% endblock %}
<div class="button-container" style="position: fixed; bottom: 0; width: 100%; text-align: center;">
  <button class="w3-button w3-teal homeButton" style="text-align: center;" onclick="window.location.href='/login'">Login</button>
  <button class="w3-button w3-teal" onclick="window.location.href='/FHIR-Visualization'">Dashboard</button>
  <button class="w3-button w3-teal" onclick="window.location.href='/'">Home Page</button>
  
</div>

</div>

<script>
function w3_open() {
  document.getElementById("main").style.marginLeft = "25%";
  document.getElementById("mySidebar").style.width = "25%";
  document.getElementById("mySidebar").style.display = "block";
  document.getElementById("openNav").style.display = 'none';
}
function w3_close() {
  document.getElementById("main").style.marginLeft = "0%";
  document.getElementById("mySidebar").style.display = "none";
  document.getElementById("openNav").style.display = "inline-block";
}
function myAccFunc(tabIndex) {
  var x = document.getElementById("clinicalAcc");
  var y = document.getElementById("diagnosticAcc");
  var z = document.getElementById("medicationAcc");
  var a = document.getElementById("workflowAcc");
  var b = document.getElementById("financialAcc");

  switch(tabIndex) {
    case 0:
      if (x.className.indexOf("w3-show") == -1) {
        x.className += " w3-show";
        document.getElementById("clinicalBtn").classList.add("w3-green");
      } else { 
        x.className = x.className.replace(" w3-show", "");
        document.getElementById("clinicalBtn").classList.remove("w3-green");
      }
      break;
    case 1:
      if (y.className.indexOf("w3-show") == -1) {
        y.className += " w3-show";
        document.getElementById("diagnosticBtn").classList.add("w3-green");
      } else { 
        y.className = y.className.replace(" w3-show", "");
        document.getElementById("diagnosticBtn").classList.remove("w3-green");
      }
      break;
    case 2:
      if (z.className.indexOf("w3-show") == -1) {
        z.className += " w3-show";
        document.getElementById("medicationBtn").classList.add("w3-green");
      } else { 
        z.className = z.className.replace(" w3-show", "");
        document.getElementById("medicationBtn").classList.remove("w3-green");
      }
      break;
    case 3:
      if (a.className.indexOf("w3-show") == -1) {
        a.className += " w3-show";
        document.getElementById("workflowBtn").classList.add("w3-green");
      } else { 
        a.className = a.className.replace(" w3-show", "");
        document.getElementById("workflowBtn").classList.remove("w3-green");
      }
      break;
    case 4:
      if (b.className.indexOf("w3-show") == -1) {
        b.className += " w3-show";
        document.getElementById("financialBtn").classList.add("w3-green");
      } else { 
        b.className = b.className.replace(" w3-show", "");
        document.getElementById("financialBtn").classList.remove("w3-green");
      }
      break;
    }
}



// JavaScript code for form submission
document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('checkboxForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission

            let domain = document.getElementById('pageTitle').textContent;

            let checkboxes = document.getElementsByName('query');
            let checkedValues = [];

            // Collect checked values and their associated graph types
            for (let i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    let query = checkboxes[i].value;
                    let graphType = document.querySelector(`select[name=graphType${i + 1}]`).value;
                    checkedValues.push({ query, graphType });
                }
            }
            let data = JSON.stringify({checkedValues,domain})

            //send data to server
            
            fetch('/process_form', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: data
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response from server:', data);
                chartResults(data)
            })
            .catch(error => {
                console.error('Error:', error);
            });

            
            
        });
    });

function chartResults(chartData) {
    // Select the result container
    var resultContainer = d3.select(".result-container");
    var row = null;
    // Loop through each entry in the JSON object
    chartData.result.forEach(function(entry, index) {
          
      
        // Parse the data string to convert it into JSON object
        if (typeof entry === 'object' && entry !== null) {
          var data = JSON.parse(entry.data);
          var totCharts = entry.numGraphs;
          var svg;
          // Calculate graph width based on number of charts
          var graphWidth = 100 / 2 - 20; // Two charts per row
          var chartLength = graphWidth
          
          // Create a new row for graphs every 2 graphs (show in rows of 2 max)
        //Also makes a row for 1st chart to put in its place
        if (index % 2 === 0 || index === 0) {
            row = resultContainer.append("div")
            .classed("row", true)
            .style("margin-bottom", "20px");
        }
          
          // Create a new SVG element for each chart
          svg = row.append("svg")
            .attr("width", graphWidth + "%")
            .attr("height", 200)
            .attr("length",chartLength + "%")
            .style("padding", "0 10px");
                 
          // Check the chart type and create corresponding chart
          switch (entry.chartType) {
              case "bar":
                  createBarChart(data, svg);
                  break;
              case "pie":
                  createPieChart(data, svg);
                  break;
              case "line":
                  createLineChart(data, svg);
                  break;
              case "table":
                  createTable(data, svg);
                  break;
              default:
                  console.log("Unknown / unsupported chart type:", entry.chartType)
          }
        }
    });
    
}


// Function to create a bar chart
function createBarChart(data, svg) {
    console.log("Bar chart with:", data)
    var processedData = Object.keys(data).map(function(key) {
        return { x: key, y: data[key] };
    });
    // Assuming data is an array of objects with 'x' and 'y' properties
    var margin = { top: 20, right: 20, bottom: 30, left: 40 },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;

    var x = d3.scaleBand()
        .rangeRound([0, width])
        .padding(0.1)
        .domain(data.map(function(d) { return d.x; }));

    var y = d3.scaleLinear()
        .rangeRound([height, 0])
        .domain([0, d3.max(data, function(d) { return d.y; })]);

    var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

    g.append("g")
        .attr("class", "axis axis--y")
        .call(d3.axisLeft(y).ticks(10, "%"))
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
        .text("Frequency");

    g.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .attr("class", "bar")
        .attr("x", function(d) { return x(d.x); })
        .attr("y", function(d) { return y(d.y); })
        .attr("width", x.bandwidth())
        .attr("height", function(d) { return height - y(d.y); });
}


function createPieChart(data, svg) {
  console.log("Pie chart with:", data)
  var processedData = Object.keys(data).map(function(key) {
        return { label: key, value: data[key] };
    });
    // Assuming data is an array of objects with 'label' and 'value' properties
    var radius = Math.min(svg.attr("width"), svg.attr("height")) / 2;
    var g = svg.append("g").attr("transform", "translate(" + radius + "," + radius + ")");

    var color = d3.scaleOrdinal(d3.schemeCategory10);
    var pie = d3.pie().value(function(d) { return d.value; });
    var arc = d3.arc().outerRadius(radius - 10).innerRadius(0);

    var arcs = g.selectAll("arc")
        .data(pie(data))
        .enter()
        .append("g")
        .attr("class", "arc");

    arcs.append("path")
        .attr("d", arc)
        .attr("fill", function(d) { return color(d.data.label); });

    var legend = svg.selectAll(".legend")
        .data(data)
        .enter()
        .append("g")
        .attr("class", "legend")
        .attr("transform", function(d, i) { return "translate(20," + i * 20 + ")"; });

    legend.append("rect")
        .attr("x", radius * 2)
        .attr("width", 18)
        .attr("height", 18)
        .style("fill", function(d) { return color(d.label); });

    legend.append("text")
        .attr("x", radius * 2 - 6)
        .attr("y", 9)
        .attr("dy", ".35em")
        .style("text-anchor", "end")
        .text(function(d) { return d.label; });
}


function createLineChart(data, svg) {
  console.log("Line chart with:", data)
  // Convert data object into an array of { x, y } objects
  var processedData = Object.keys(data).map(function(key) {
        return { x: key, y: data[key] };
    });

    // Assuming data is an array of objects with 'x' and 'y' properties
    var margin = { top: 20, right: 20, bottom: 30, left: 50 },
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom;

    var x = d3.scaleLinear().range([0, width]);
    var y = d3.scaleLinear().range([height, 0]);

    var line = d3.line()
        .x(function(d) { return x(d.x); })
        .y(function(d) { return y(d.y); });

    var g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    x.domain(d3.extent(data, function(d) { return d.x; }));
    y.domain(d3.extent(data, function(d) { return d.y; }));

    g.append("g")
        .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

    g.append("g")
        .attr("class", "axis axis--y")
        .call(d3.axisLeft(y))
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", "0.71em")
        .attr("text-anchor", "end")
        .text("Value");

    g.append("path")
        .datum(data)
        .attr("class", "line")
        .attr("d", line);
}


function createTable(data, svg) {
  console.log("Table chart with:", data)
  // Convert data object into an array of { x, y } objects
  var processedData = Object.keys(data).map(function(key) {
        var obj = {};
        obj[key] = data[key];
        return obj;
    });
    // Assuming data is an array of objects with properties representing table columns
    var table = svg.append("table");
    var thead = table.append("thead").append("tr");
    var tbody = table.append("tbody");

    // Append table headers
    thead.selectAll("th")
        .data(d3.keys(data[0]))
        .enter().append("th")
        .text(function(column) { return column; });

    // Create table rows
    var rows = tbody.selectAll("tr")
        .data(data)
        .enter().append("tr");

    // Populate table cells with data
    var cells = rows.selectAll("td")
        .data(function(row) {
            return d3.keys(row).map(function(column) {
                return { column: column, value: row[column] };
            });
        })
        .enter().append("td")
        .text(function(d) { return d.value; });
}

</script>


</body>
</html>

